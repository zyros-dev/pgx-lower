-- Test WHERE clause with pattern matching: LIKE, ILIKE, IN, ANY operators
LOAD 'pgx_lower';
NOTICE:  Installing custom executor hook...
NOTICE:  Registering custom sigsegv handler!
DROP TABLE IF EXISTS test_where_patterns;
NOTICE:  table "test_where_patterns" does not exist, skipping
CREATE TABLE test_where_patterns (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50),
    email VARCHAR(100),
    department VARCHAR(20),
    salary INTEGER,
    status VARCHAR(10)
);

INSERT INTO test_where_patterns(name, email, department, salary, status) VALUES 
    ('Alice Smith', 'alice.smith@company.com', 'Engineering', 75000, 'active'),
    ('Bob Johnson', 'bob.j@company.com', 'Marketing', 65000, 'inactive'),
    ('Carol Davis', 'carol.davis@company.com', 'Engineering', 80000, 'active'),
    ('David Wilson', 'david@company.com', 'Sales', 70000, 'active'),
    ('Eve Brown', 'eve.brown@company.com', 'Marketing', 68000, 'pending'),
    ('Frank Miller', 'frank.m@company.com', 'Sales', 72000, 'active'),
    ('Grace Taylor', 'grace@company.com', 'Engineering', 85000, 'inactive');

-- Test WHERE with LIKE pattern matching
-- These should trigger MLIR compilation with string pattern operations
SELECT id, name FROM test_where_patterns WHERE name LIKE 'A%';
 id |    name     
----+-------------
  1 | Alice Smith
(1 row)

SELECT id, name FROM test_where_patterns WHERE name LIKE '%Smith';
 id |    name     
----+-------------
  1 | Alice Smith
(1 row)

SELECT id, name FROM test_where_patterns WHERE name LIKE '%o%';
 id |     name     
----+--------------
  2 | Bob Johnson
  5 | Eve Brown
(2 rows)

SELECT id, email FROM test_where_patterns WHERE email LIKE '%.%@%';
 id |           email           
----+---------------------------
  1 | alice.smith@company.com
  2 | bob.j@company.com
  3 | carol.davis@company.com
  5 | eve.brown@company.com
  6 | frank.m@company.com
(5 rows)

SELECT id, email FROM test_where_patterns WHERE email LIKE '%company.com';
 id |           email           
----+---------------------------
  1 | alice.smith@company.com
  2 | bob.j@company.com
  3 | carol.davis@company.com
  4 | david@company.com
  5 | eve.brown@company.com
  6 | frank.m@company.com
  7 | grace@company.com
(7 rows)

-- Test WHERE with LIKE and wildcards
SELECT id, name FROM test_where_patterns WHERE name LIKE '___ %';  -- Three letter first name
 id |    name     
----+-------------
  2 | Bob Johnson
  5 | Eve Brown
(2 rows)

SELECT id, name FROM test_where_patterns WHERE name LIKE '% _____';  -- Five letter last name
 id |     name     
----+--------------
  1 | Alice Smith
  5 | Eve Brown
  6 | Frank Miller
(3 rows)

SELECT department FROM test_where_patterns WHERE department LIKE '%ing';
 department  
-------------
 Engineering
 Marketing
 Engineering
 Marketing
 Engineering
(5 rows)

-- Test WHERE with NOT LIKE
SELECT id, name FROM test_where_patterns WHERE name NOT LIKE 'A%';
 id |     name     
----+--------------
  2 | Bob Johnson
  3 | Carol Davis
  4 | David Wilson
  5 | Eve Brown
  6 | Frank Miller
  7 | Grace Taylor
(6 rows)

SELECT id, email FROM test_where_patterns WHERE email NOT LIKE '%@company.com';
 id | email 
----+-------
(0 rows)

-- Test WHERE with IN operator
SELECT id, name, department FROM test_where_patterns WHERE department IN ('Engineering', 'Sales');
 id |     name     | department  
----+--------------+-------------
  1 | Alice Smith  | Engineering
  3 | Carol Davis  | Engineering
  4 | David Wilson | Sales
  6 | Frank Miller | Sales
  7 | Grace Taylor | Engineering
(5 rows)

SELECT id, name, status FROM test_where_patterns WHERE status IN ('active', 'pending');
 id |     name     | status  
----+--------------+---------
  1 | Alice Smith  | active
  3 | Carol Davis  | active
  4 | David Wilson | active
  5 | Eve Brown    | pending
  6 | Frank Miller | active
(5 rows)

SELECT id, name FROM test_where_patterns WHERE salary IN (75000, 80000, 85000);
 id |     name     
----+--------------
  1 | Alice Smith
  3 | Carol Davis
  7 | Grace Taylor
(3 rows)

-- Test WHERE with NOT IN operator
SELECT id, name, department FROM test_where_patterns WHERE department NOT IN ('Marketing');
 id |     name     | department  
----+--------------+-------------
  1 | Alice Smith  | Engineering
  3 | Carol Davis  | Engineering
  4 | David Wilson | Sales
  6 | Frank Miller | Sales
  7 | Grace Taylor | Engineering
(5 rows)

SELECT id, name, status FROM test_where_patterns WHERE status NOT IN ('inactive');
 id |     name     | status  
----+--------------+---------
  1 | Alice Smith  | active
  3 | Carol Davis  | active
  4 | David Wilson | active
  5 | Eve Brown    | pending
  6 | Frank Miller | active
(5 rows)

-- Test WHERE with IN and subqueries (if supported)
SELECT id, name FROM test_where_patterns WHERE department IN (SELECT DISTINCT department FROM test_where_patterns WHERE salary > 70000);
 id |     name     
----+--------------
  1 | Alice Smith
  3 | Carol Davis
  6 | Frank Miller
  7 | Grace Taylor
(4 rows)

-- Test WHERE with pattern matching and logical combinations
SELECT id, name, department FROM test_where_patterns WHERE name LIKE 'C%' AND department = 'Engineering';
 id |    name     | department  
----+-------------+-------------
  3 | Carol Davis | Engineering
(1 row)

SELECT id, name, salary FROM test_where_patterns WHERE (name LIKE '%e%' OR name LIKE '%a%') AND salary > 70000;
 id |     name     | salary 
----+--------------+--------
  1 | Alice Smith  |  75000
  3 | Carol Davis  |  80000
  6 | Frank Miller |  72000
  7 | Grace Taylor |  85000
(4 rows)

SELECT id, name FROM test_where_patterns WHERE department IN ('Engineering', 'Sales') AND status = 'active';
 id |     name     
----+--------------
  1 | Alice Smith
  3 | Carol Davis
  4 | David Wilson
  6 | Frank Miller
(4 rows)

-- Test WHERE with complex pattern combinations
SELECT id, name, email FROM test_where_patterns WHERE name LIKE '%a%' AND email LIKE '%@company.com' AND department NOT IN ('Marketing');
 id |     name     |           email           
----+--------------+---------------------------
  1 | Alice Smith  | alice.smith@company.com
  3 | Carol Davis  | carol.davis@company.com
  6 | Frank Miller | frank.m@company.com
  7 | Grace Taylor | grace@company.com
(4 rows)

SELECT id, name, department FROM test_where_patterns WHERE (name NOT LIKE 'A%' AND name NOT LIKE 'B%') OR department = 'Engineering';
 id |     name     | department  
----+--------------+-------------
  1 | Alice Smith  | Engineering
  3 | Carol Davis  | Engineering
  4 | David Wilson | Sales
  5 | Eve Brown    | Marketing
  6 | Frank Miller | Sales
  7 | Grace Taylor | Engineering
(6 rows)

DROP TABLE test_where_patterns;