LOAD 'pgx_lower.so';
DROP TABLE IF EXISTS sort_test;
NOTICE:  table "sort_test" does not exist, skipping
CREATE TABLE sort_test (
    id INTEGER,
    name TEXT
);
INSERT INTO sort_test VALUES
    (1, 'Zebra'),
    (2, 'Apple'),
    (3, 'Mango'),
    (4, 'Banana');
SELECT name FROM sort_test ORDER BY name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
  name  
--------
 Apple
 Banana
 Mango
 Zebra
(4 rows)

SELECT t1.name
FROM sort_test t1
JOIN sort_test t2 ON t1.id = t2.id
ORDER BY t1.name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
  name  
--------
 Apple
 Banana
 Mango
 Zebra
(4 rows)

DROP TABLE IF EXISTS regions;
NOTICE:  table "regions" does not exist, skipping
DROP TABLE IF EXISTS countries;
NOTICE:  table "countries" does not exist, skipping
CREATE TABLE regions (
    region_id INTEGER,
    region_name TEXT
);
CREATE TABLE countries (
    country_id INTEGER,
    country_name TEXT,
    region_id INTEGER
);
INSERT INTO regions VALUES
    (1, 'Asia'),
    (2, 'Europe'),
    (3, 'Americas');
INSERT INTO countries VALUES
    (1, 'India', 1),
    (2, 'China', 1),
    (3, 'France', 2),
    (4, 'Germany', 2),
    (5, 'Brazil', 3),
    (6, 'Canada', 3);
SELECT r.region_name, COUNT(*) as country_count
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY r.region_name
ORDER BY r.region_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | country_count 
-------------+---------------
 Americas    |             2
 Asia        |             2
 Europe      |             2
(3 rows)

SELECT c.country_name
FROM countries c
JOIN regions r1 ON c.region_id = r1.region_id
JOIN regions r2 ON r1.region_id = r2.region_id
WHERE r2.region_name = 'Asia'
ORDER BY c.country_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 country_name 
--------------
 China
 India
(2 rows)

SELECT country_name
FROM (
    SELECT c.country_name, r.region_id
    FROM countries c
    JOIN regions r ON c.region_id = r.region_id
    WHERE r.region_name IN ('Asia', 'Europe')
) sub
ORDER BY country_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 country_name 
--------------
 China
 France
 Germany
 India
(4 rows)

DROP TABLE IF EXISTS bpchar_test;
NOTICE:  table "bpchar_test" does not exist, skipping
CREATE TABLE bpchar_test (
    id INTEGER,
    code CHAR(5)
);
INSERT INTO bpchar_test VALUES
    (1, 'ZZZ'),
    (2, 'AAA'),
    (3, 'MMM'),
    (4, 'BBB');
SELECT code FROM bpchar_test ORDER BY code;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 code  
-------
 AAA  
 BBB  
 MMM  
 ZZZ  
(4 rows)

SELECT c.country_name, SUM(c.country_id) as total
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY c.country_name
ORDER BY total DESC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 country_name | total 
--------------+-------
 Canada       |     6
 Brazil       |     5
 Germany      |     4
 France       |     3
 China        |     2
 India        |     1
(6 rows)

DROP TABLE IF EXISTS date_test;
NOTICE:  table "date_test" does not exist, skipping
CREATE TABLE date_test (
    id INTEGER,
    event_date DATE
);
INSERT INTO date_test VALUES
    (1, '2024-12-31'),
    (2, '2024-01-01'),
    (3, '2024-06-15'),
    (4, '2024-03-20');
SELECT event_date FROM date_test ORDER BY event_date;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 event_date 
------------
 01-01-2024
 03-20-2024
 06-15-2024
 12-31-2024
(4 rows)

DROP TABLE IF EXISTS timestamp_test;
NOTICE:  table "timestamp_test" does not exist, skipping
CREATE TABLE timestamp_test (
    id INTEGER,
    event_time TIMESTAMP
);
INSERT INTO timestamp_test VALUES
    (1, '2024-12-31 23:59:59'),
    (2, '2024-01-01 00:00:00'),
    (3, '2024-06-15 12:30:00'),
    (4, '2024-03-20 08:15:30');
SELECT event_time FROM timestamp_test ORDER BY event_time;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
        event_time        
--------------------------
 Mon Jan 01 00:00:00 2024
 Wed Mar 20 08:15:30 2024
 Sat Jun 15 12:30:00 2024
 Tue Dec 31 23:59:59 2024
(4 rows)

SELECT r.region_name,
       COUNT(*) as country_count,
       SUM(c.country_id) as total_ids
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY r.region_name
ORDER BY total_ids DESC, r.region_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | country_count | total_ids 
-------------+---------------+-----------
 Americas    |             2 |        11
 Europe      |             2 |         7
 Asia        |             2 |         3
(3 rows)

SELECT r.region_name, COUNT(*) as cnt
FROM regions r
JOIN regions r2 ON r.region_id = r2.region_id
GROUP BY r.region_name
ORDER BY r.region_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | cnt 
-------------+-----
 Americas    |   1
 Asia        |   1
 Europe      |   1
(3 rows)

DROP TABLE IF EXISTS mixed_sort_test;
NOTICE:  table "mixed_sort_test" does not exist, skipping
CREATE TABLE mixed_sort_test (
    id INTEGER,
    name TEXT,
    value DECIMAL(10, 2)
);
INSERT INTO mixed_sort_test VALUES
    (1, 'Alpha', 100.50),
    (2, 'Beta', 200.75),
    (3, 'Alpha', 150.25),
    (4, 'Gamma', 100.50),
    (5, 'Beta', 100.50);
SELECT value, name
FROM mixed_sort_test
ORDER BY value DESC, name ASC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 value  | name  
--------+-------
 200.75 | Beta
 150.25 | Alpha
  100.5 | Alpha
  100.5 | Beta
  100.5 | Gamma
(5 rows)

SELECT r.region_name,
       COUNT(*) as cnt,
       SUM(c.country_id) as total
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY r.region_name
ORDER BY cnt DESC, r.region_name ASC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | cnt | total 
-------------+-----+-------
 Americas    |   2 |    11
 Asia        |   2 |     3
 Europe      |   2 |     7
(3 rows)

SELECT value, name
FROM mixed_sort_test
ORDER BY value DESC, name DESC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 value  | name  
--------+-------
 200.75 | Beta
 150.25 | Alpha
  100.5 | Gamma
  100.5 | Beta
  100.5 | Alpha
(5 rows)

SELECT r.region_name,
       c.country_name,
       c.country_id
FROM countries c
JOIN regions r ON c.region_id = r.region_id
ORDER BY r.region_name ASC, country_id DESC, c.country_name ASC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | country_name | country_id 
-------------+--------------+------------
 Americas    | Canada       |          6
 Americas    | Brazil       |          5
 Asia        | China        |          2
 Asia        | India        |          1
 Europe      | Germany      |          4
 Europe      | France       |          3
(6 rows)

SELECT EXTRACT(year FROM event_date) as year, COUNT(*) as cnt
FROM date_test
GROUP BY EXTRACT(year FROM event_date)
ORDER BY year;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 year | cnt 
------+-----
 2024 |   4
(1 row)

SELECT
    CASE
        WHEN c.country_id < 3 THEN 'Low'
        WHEN c.country_id < 5 THEN 'Medium'
        ELSE 'High'
    END as category,
    COUNT(*) as cnt
FROM countries c
GROUP BY category
ORDER BY category;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 category | cnt 
----------+-----
 High     |   2
 Low      |   2
 Medium   |   2
(3 rows)

SELECT r.region_name,
       SUM(c.country_id) as total,
       COUNT(*) as cnt,
       SUM(c.country_id) / COUNT(*) as avg_id
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY r.region_name
ORDER BY avg_id DESC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | total | cnt | avg_id 
-------------+-------+-----+--------
 Americas    |    11 |   2 |      5
 Europe      |     7 |   2 |      3
 Asia        |     3 |   2 |      1
(3 rows)

SELECT year, total_countries
FROM (
    SELECT EXTRACT(year FROM event_date) as year,
           COUNT(*) as total_countries
    FROM date_test
    GROUP BY EXTRACT(year FROM event_date)
) sub
ORDER BY year;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 year | total_countries 
------+-----------------
 2024 |               4
(1 row)

SELECT r.region_name,
       SUM(CASE WHEN c.country_id < 4 THEN c.country_id ELSE 0 END) as conditional_sum,
       SUM(c.country_id) as total_sum
FROM countries c
JOIN regions r ON c.region_id = r.region_id
GROUP BY r.region_name
ORDER BY r.region_name;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | conditional_sum | total_sum 
-------------+-----------------+-----------
 Americas    |               0 |        11
 Asia        |               3 |         3
 Europe      |               3 |         7
(3 rows)

SELECT sub.region_name,
       sub.conditional_sum / sub.total_sum as ratio
FROM (
    SELECT r.region_name,
           SUM(CASE WHEN c.country_id < 4 THEN c.country_id ELSE 0 END) as conditional_sum,
           SUM(c.country_id) as total_sum
    FROM countries c
    JOIN regions r ON c.region_id = r.region_id
    GROUP BY r.region_name
) sub
ORDER BY ratio DESC;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 region_name | ratio 
-------------+-------
 Asia        |     3
 Europe      |     3
 Americas    |     0
(3 rows)

