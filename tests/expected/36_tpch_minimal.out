LOAD 'pgx_lower.so';
DROP TABLE IF EXISTS simple_orders CASCADE;
NOTICE:  table "simple_orders" does not exist, skipping
DROP TABLE IF EXISTS simple_items CASCADE;
NOTICE:  table "simple_items" does not exist, skipping
DROP TABLE IF EXISTS simple_customers CASCADE;
NOTICE:  table "simple_customers" does not exist, skipping
CREATE TABLE simple_orders (
    o_id INTEGER PRIMARY KEY,
    o_date DATE NOT NULL,
    o_amount DECIMAL(10,2) NOT NULL
);
CREATE TABLE simple_items (
    i_id INTEGER PRIMARY KEY,
    i_order_id INTEGER NOT NULL,
    i_price DECIMAL(10,2) NOT NULL,
    i_discount DECIMAL(3,2) NOT NULL
);
CREATE TABLE simple_customers (
    c_id INTEGER PRIMARY KEY,
    c_name VARCHAR(50) NOT NULL,
    c_order_id INTEGER
);
INSERT INTO simple_orders VALUES
    (1, '1994-01-15', 100.00),
    (2, '1994-06-20', 200.00),
    (3, '1995-03-10', 150.00),
    (4, '1995-08-25', 300.00);
INSERT INTO simple_items VALUES
    (1, 1, 50.00, 0.05),
    (2, 1, 50.00, 0.10),
    (3, 2, 100.00, 0.05),
    (4, 2, 100.00, 0.00),
    (5, 3, 75.00, 0.10),
    (6, 4, 150.00, 0.05);
INSERT INTO simple_customers VALUES
    (1, 'Customer A', 1),
    (2, 'Customer B', 2),
    (3, 'Customer C', NULL);
SELECT o_id, o_date, o_amount
FROM simple_orders
WHERE o_date <= date '1994-07-01' - interval '90' day
ORDER BY o_id;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 o_id |   o_date   | o_amount 
------+------------+----------
    1 | 01-15-1994 |      100
(1 row)

SELECT o_id, o_date
FROM simple_orders
WHERE o_date >= date '1994-01-01' AND o_date < date '1995-01-01'
ORDER BY o_id;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 o_id |   o_date   
------+------------
    1 | 01-15-1994
    2 | 06-20-1994
(2 rows)

SELECT o.o_id, i.i_id, i.i_price * (1 - i.i_discount) as discounted
FROM simple_orders o, simple_items i
WHERE o.o_id = i.i_order_id
  AND o.o_date >= date '1994-01-01'
  AND i.i_discount > 0.00
ORDER BY o.o_id, i.i_id;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 o_id | i_id | discounted 
------+------+------------
    1 |    1 |       47.5
    1 |    2 |         45
    2 |    3 |         95
    3 |    5 |       67.5
    4 |    6 |      142.5
(5 rows)

SELECT o_id, o_date
FROM simple_orders o
WHERE o.o_date >= date '1994-01-01'
  AND EXISTS (
      SELECT 1 FROM simple_items i
      WHERE i.i_order_id = o.o_id
      AND i.i_discount > 0
  )
ORDER BY o_id;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 o_id |   o_date   
------+------------
    1 | 01-15-1994
    2 | 06-20-1994
    3 | 03-10-1995
    4 | 08-25-1995
(4 rows)

SELECT sum(i_price * (1 - i_discount)) as total_revenue
FROM simple_items i, simple_orders o
WHERE i.i_order_id = o.o_id
  AND o.o_date >= date '1994-01-01'
  AND o.o_date < date '1995-01-01';
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 total_revenue 
---------------
         287.5
(1 row)

SELECT c.c_id, c.c_name, count(i.i_id) as item_count
FROM simple_customers c
LEFT OUTER JOIN simple_items i ON c.c_order_id = i.i_order_id
GROUP BY c.c_id, c.c_name
ORDER BY c.c_id;
NOTICE:  [PGX-LOWER] Routing through PGX_LOWER compilation
 c_id |   c_name   | item_count 
------+------------+------------
    1 | Customer A |          2
    2 | Customer B |          2
    3 | Customer C |          0
(3 rows)

DROP TABLE simple_orders CASCADE;
DROP TABLE simple_items CASCADE;
DROP TABLE simple_customers CASCADE;
